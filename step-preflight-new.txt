function StepPreflight({
  formData,
  setFormData,
  module,
}: {
  formData: BookingFormData;
  setFormData: (data: BookingFormData) => void;
  module: import("@/lib/types").ServiceModule;
}) {
  const moduleConfig = MODULES[module as ModuleId];
  const preflightItems = moduleConfig?.preflightChecklist || [];
  const [showWarning, setShowWarning] = useState(false);

  // Load persisted state on mount
  useEffect(() => {
    const loadSavedState = async () => {
      try {
        const { loadPreflightState } = await import("@/lib/preflight-storage");
        const savedState = loadPreflightState(module as ModuleId);
        if (savedState && savedState.checkedItemIds.length > 0) {
          const checked: Record<string, boolean> = {};
          savedState.checkedItemIds.forEach(id => {
            checked[id] = true;
          });
          setFormData({
            ...formData,
            preflightChecked: checked,
          });
        }
      } catch (error) {
        console.error("Failed to load preflight state:", error);
      }
    };
    loadSavedState();
  }, [module]);

  const toggleItem = async (itemId: string) => {
    const newChecked = {
      ...formData.preflightChecked,
      [itemId]: !formData.preflightChecked?.[itemId],
    };
    
    setFormData({
      ...formData,
      preflightChecked: newChecked,
    });

    // Save to localStorage
    try {
      const { savePreflightState } = await import("@/lib/preflight-storage");
      const checkedIds = Object.keys(newChecked).filter(id => newChecked[id]);
      savePreflightState(module as ModuleId, checkedIds);
    } catch (error) {
      console.error("Failed to save preflight state:", error);
    }
    
    // Hide warning when user starts checking items
    if (showWarning) {
      setShowWarning(false);
    }
  };

  const requiredItems = preflightItems.filter(item => item.required);
  const allRequiredCompleted = requiredItems.every(
    item => formData.preflightChecked?.[item.id]
  );

  // Store completion status for backend
  useEffect(() => {
    setFormData({
      ...formData,
      preflightCompleted: allRequiredCompleted,
    });
  }, [allRequiredCompleted]);

  return (
    <div className="space-y-6">
      <div>
        <h3 className="text-xl font-semibold text-white mb-2">
          Preflight Checklist
        </h3>
        <p className="text-gray-400">
          Make sure you have these items ready before submitting your booking
        </p>
      </div>

      <div className="bg-blue-500/10 border border-blue-500/50 rounded-lg p-4">
        <div className="flex gap-3">
          <svg className="w-5 h-5 text-blue-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <p className="text-sm text-blue-300">
            These items help us deliver the best results. Check each item as you prepare it.
          </p>
        </div>
      </div>

      {/* Soft-gate warning */}
      {showWarning && !allRequiredCompleted && (
        <div className="bg-yellow-500/10 border border-yellow-500/50 rounded-lg p-4">
          <div className="flex gap-3">
            <svg className="w-5 h-5 text-yellow-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            <div>
              <p className="text-yellow-400 font-medium mb-1">Some required items are not completed</p>
              <p className="text-sm text-gray-300">
                You haven''t completed all required items. We''ll review these with you on the kickoff call.
              </p>
            </div>
          </div>
        </div>
      )}

      <div className="space-y-3">
        {preflightItems.map((item) => (
          <label
            key={item.id}
            className="flex items-start gap-3 p-4 bg-background rounded-lg hover:bg-gray-900 cursor-pointer transition-colors group"
          >
            <input
              type="checkbox"
              checked={formData.preflightChecked?.[item.id] || false}
              onChange={() => toggleItem(item.id)}
              className="mt-1 w-4 h-4 rounded border-gray-700 bg-gray-800 text-primary focus:ring-primary focus:ring-offset-0"
            />
            <div className="flex-1">
              <span className="text-white group-hover:text-primary transition-colors">
                {item.label}
              </span>
              {item.required && (
                <span className="ml-2 px-2 py-0.5 bg-red-500/20 text-red-400 text-xs rounded">
                  Required
                </span>
              )}
            </div>
          </label>
        ))}
      </div>

      {/* Progress indicator */}
      <div className="bg-background rounded-lg p-4">
        <div className="flex items-center justify-between mb-2">
          <span className="text-sm font-medium text-gray-400">Progress</span>
          <span className="text-sm font-medium text-white">
            {Object.values(formData.preflightChecked || {}).filter(Boolean).length} / {preflightItems.length}
          </span>
        </div>
        <div className="w-full bg-gray-800 rounded-full h-2">
          <div 
            className="bg-primary h-2 rounded-full transition-all duration-300"
            style={{ 
              width: `${(Object.values(formData.preflightChecked || {}).filter(Boolean).length / preflightItems.length) * 100}%` 
            }}
          />
        </div>
      </div>
    </div>
  );
}
